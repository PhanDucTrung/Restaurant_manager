<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Th·ªëng k√™</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">RM</div>
        <div>
          <div style="font-weight:700">Qu·∫£n L√Ω Nh√† H√†ng</div>
          <div class="small">v1.0 ‚Ä¢ Spring Boot + MongoDB</div>
        </div>
      </div>
      <nav class="nav">
        <a href="/tables.html">ü™ë Tr·∫°ng th√°i b√†n</a>
        <a href="/menu.html">üìã D·ªãch v·ª•</a>
        <a href="/orders.html">üßæ H√≥a ƒë∆°n</a>
        <a href="/customers.html">üë• Kh√°ch h√†ng</a>
        <a href="/dashboard.html" class="active">üìä Th·ªëng k√™</a>
        <a href="/employees.html">üë®‚Äçüç≥ Nh√¢n vi√™n</a>
      </nav>
      <div style="margin-top:20px" class="small">Tr·∫°ng th√°i</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap" id="statusPills">
        <div class="pill">ƒêang t·∫£i...</div>
      </div>
    </aside>
    <main class="main">
      <header>
        <div style="display:flex;gap:12px;align-items:center">
          <h2 id="pageTitle">Th·ªëng k√™</h2>
          <div class="small">/ T·ªïng quan h·ªá th·ªëng</div>
        </div>
        <div class="actions">
          <div class="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input placeholder="T√¨m ki·∫øm..." id="globalSearch" />
          </div>
          <button class="btn" onclick="loadDashboard();">‚ü≥ L√†m m·ªõi</button>
        </div>
      </header>
      <section id="dashboard" class="view">
        <div class="grid-4">
          <div class="card">
            <h3>Doanh thu h√¥m nay</h3>
            <p id="todayRevenue">‚Ç´ 0</p>
          </div>
          <div class="card">
            <h3>ƒê∆°n h√†ng (h√¥m nay)</h3>
            <p id="todayOrders">0</p>
          </div>
          <div class="card">
            <h3>B√†n ƒëang ph·ª•c v·ª•</h3>
            <p id="occupiedTables">0 / 0</p>
          </div>
          <div class="card">
            <h3>Nguy√™n li·ªáu c·∫ßn nh·∫≠p</h3>
            <p id="lowStock">0 m·ª•c</p>
          </div>
        </div>

        <div class="panel">
          <h3 style="margin-top:0">Danh s√°ch b√†n</h3>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>T√™n</th>
                <th>Khu v·ª±c</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="tablesList">
              <tr><td colspan="5" class="loading">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="panel">
          <h3 style="margin-top:0">ƒê∆°n h√†ng m·ªõi nh·∫•t</h3>
          <table>
            <thead>
              <tr>
                <th>M√£</th>
                <th>Kh√°ch</th>
                <th>Lo·∫°i</th>
                <th>T·ªïng</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="ordersList">
              <tr><td colspan="5" class="loading">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
      <footer>¬© 2025 Qu·∫£n L√Ω Nh√† H√†ng ‚Äî Giao di·ªán qu·∫£n l√Ω nh√† h√†ng</footer>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    async function loadDashboard() {
      try {
        const [tables, orders, payments] = await Promise.all([
          api.getTables(),
          api.getOrders(),
          api.getPayments()
        ]);

        // Update stats
        const today = new Date().toISOString().split('T')[0];
        const todayOrders = orders.filter(o => o.createdAt && o.createdAt.startsWith(today));
        const todayPayments = payments.filter(p => p.createdAt && p.createdAt.startsWith(today));
        const todayRevenue = todayPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
        
        const occupiedTables = tables.filter(t => t.status === 'occupied').length;
        
        document.getElementById('todayRevenue').textContent = `‚Ç´ ${todayRevenue.toLocaleString('vi-VN')}`;
        document.getElementById('todayOrders').textContent = todayOrders.length;
        document.getElementById('occupiedTables').textContent = `${occupiedTables} / ${tables.length}`;

        // Render tables
        const tablesList = document.getElementById('tablesList');
        if (tables.length === 0) {
          tablesList.innerHTML = '<tr><td colspan="5" class="empty-state">Ch∆∞a c√≥ b√†n n√†o</td></tr>';
        } else {
          tablesList.innerHTML = tables.slice(0, 10).map((t, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${t.name || '-'}</td>
              <td>${t.area || '-'}</td>
              <td><span class="status-${t.status}">${t.status || '-'}</span></td>
              <td><button class="pill" onclick="window.location.href='/tables.html?id=${t.id}'">View</button></td>
            </tr>
          `).join('');
        }

        // Render orders
        const ordersList = document.getElementById('ordersList');
        if (orders.length === 0) {
          ordersList.innerHTML = '<tr><td colspan="5" class="empty-state">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
        } else {
          ordersList.innerHTML = orders.slice(0, 10).map(o => `
            <tr>
              <td>${o.id || '-'}</td>
              <td>${o.customer?.name || '-'}</td>
              <td>${o.orderType || '-'}</td>
              <td>‚Ç´ ${(parseFloat(o.totalAmount) || 0).toLocaleString('vi-VN')}</td>
              <td><span class="status-${o.status}">${o.status || '-'}</span></td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('tablesList').innerHTML = '<tr><td colspan="5" class="empty-state">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
        document.getElementById('ordersList').innerHTML = '<tr><td colspan="5" class="empty-state">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
      }
    }

    loadDashboard();
    setInterval(loadDashboard, 30000);
    loadStatus();
  </script>
</body>
</html>

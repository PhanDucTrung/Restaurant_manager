<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tr·∫°ng th√°i b√†n</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">RM</div>
        <div>
          <div style="font-weight:700">Qu·∫£n L√Ω Nh√† H√†ng</div>
          <div class="small">v1.0 ‚Ä¢ Spring Boot + MongoDB</div>
        </div>
      </div>
      <nav class="nav">
        <a href="/tables.html" class="active">ü™ë Tr·∫°ng th√°i b√†n</a>
        <a href="/menu.html">üìã D·ªãch v·ª•</a>
        <a href="/orders.html">üßæ H√≥a ƒë∆°n</a>
        <a href="/customers.html">üë• Kh√°ch h√†ng</a>
        <a href="/dashboard.html">üìä Th·ªëng k√™</a>
        <a href="/employees.html">üë®‚Äçüç≥ Nh√¢n vi√™n</a>
      </nav>
      <div style="margin-top:20px" class="small">Tr·∫°ng th√°i</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap" id="statusPills">
        <div class="pill">ƒêang t·∫£i...</div>
      </div>
    </aside>
    <main class="main">
      <header>
        <div style="display:flex;gap:12px;align-items:center">
          <h2 id="pageTitle">Tr·∫°ng th√°i b√†n</h2>
          <div class="small">/ Qu·∫£n l√Ω b√†n</div>
        </div>
        <div class="actions">
          <div class="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input placeholder="T√¨m ki·∫øm..." id="globalSearch" />
          </div>
          <button class="btn" onclick="window.location.reload()">‚ü≥ L√†m m·ªõi</button>
        </div>
      </header>
      <section id="tables" class="view">
        <div class="panel">
          <h3 style="margin-top:0">B·∫£ng ƒëi·ªÅu khi·ªÉn B√†n</h3>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div class="small">Qu·∫£n l√Ω b·ªë tr√≠ b√†n, tr·∫°ng th√°i</div>
            <div><button class="btn" onclick="openModal('newTable')">+ Th√™m B√†n</button></div>
          </div>
          <div id="tablesGrid" class="tables-card-grid">
            <div class="loading">ƒêang t·∫£i...</div>
          </div>
        </div>
      </section>

      <footer>¬© 2025 Qu·∫£n L√Ω Nh√† H√†ng ‚Äî Giao di·ªán qu·∫£n l√Ω nh√† h√†ng</footer>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="closeModal(event)">
    <div id="modalContent" class="modal" onclick="event.stopPropagation()"></div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/pages.js"></script>
  <script>
    let editingTableId = null;

    function openModal(type, id) {
      const backdrop = document.getElementById('modalBackdrop');
      const content = document.getElementById('modalContent');
      
      if (type === 'newTable') {
        editingTableId = null;
        content.innerHTML = `
          <h3>Th√™m b√†n m·ªõi</h3>
          <form id="tableForm" onsubmit="saveTable(event)">
            <div class="form-row">
              <input class="input" name="name" placeholder="T√™n b√†n" required />
              <input class="input" name="area" placeholder="Khu v·ª±c" required />
            </div>
            <div style="margin-top:10px">
              <select class="input" name="status" required>
                <option value="Tr·ªëng">Tr·ªëng</option>
                <option value="ƒê·∫∑t tr∆∞·ªõc">ƒê·∫∑t tr∆∞·ªõc</option>
                <option value="ƒêang s·ª≠ d·ª•ng">ƒêang s·ª≠ d·ª•ng</option>
                <option value="S·ª≠a ch·ªØa">S·ª≠a ch·ªØa</option>
              </select>
            </div>
            <div class="modal-actions">
              <button type="button" onclick="closeModal()" class="pill">H·ªßy</button>
              <button type="submit" class="btn">L∆∞u</button>
            </div>
          </form>
        `;
      } else if (type === 'editTable') {
        editingTableId = id;
        api.getTableById(id).then(table => {
          if (table) {
            const currentStatus = table.status || 'Tr·ªëng';
            content.innerHTML = `
              <h3>Ch·ªânh s·ª≠a b√†n</h3>
              <form id="tableForm" onsubmit="saveTable(event)">
                <div class="form-row">
                  <input class="input" name="name" value="${table.name || ''}" placeholder="T√™n b√†n" required />
                  <input class="input" name="area" value="${table.area || ''}" placeholder="Khu v·ª±c" required />
                </div>
                <div style="margin-top:10px">
                  <select class="input" name="status" required>
                    <option value="Tr·ªëng" ${currentStatus === 'Tr·ªëng' ? 'selected' : ''}>Tr·ªëng</option>
                    <option value="ƒê·∫∑t tr∆∞·ªõc" ${currentStatus === 'ƒê·∫∑t tr∆∞·ªõc' ? 'selected' : ''}>ƒê·∫∑t tr∆∞·ªõc</option>
                    <option value="ƒêang s·ª≠ d·ª•ng" ${currentStatus === 'ƒêang s·ª≠ d·ª•ng' ? 'selected' : ''}>ƒêang s·ª≠ d·ª•ng</option>
                    <option value="S·ª≠a ch·ªØa" ${currentStatus === 'S·ª≠a ch·ªØa' ? 'selected' : ''}>S·ª≠a ch·ªØa</option>
                  </select>
                </div>
                <div class="modal-actions">
                  <button type="button" onclick="closeModal()" class="pill">H·ªßy</button>
                  <button type="submit" class="btn">C·∫≠p nh·∫≠t</button>
                </div>
              </form>
            `;
          }
        });
      }
      
      backdrop.style.display = 'flex';
    }

    async function saveTable(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const table = {
        name: formData.get('name'),
        area: formData.get('area'),
        status: formData.get('status') // L∆∞u tr·ª±c ti·∫øp ti·∫øng Vi·ªát
      };

      try {
        if (editingTableId) {
          await api.updateTable(editingTableId, table);
        } else {
          await api.createTable(table);
        }
        closeModal();
        loadTables();
        loadStatus();
      } catch (error) {
        alert('L·ªói khi l∆∞u b√†n: ' + error.message);
      }
    }

    async function deleteTable(id) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†n n√†y?')) {
        try {
          await api.deleteTable(id);
          loadTables();
          loadStatus();
        } catch (error) {
          alert('L·ªói khi x√≥a b√†n: ' + error.message);
        }
      }
    }

    function closeModal(e) {
      const backdrop = document.getElementById('modalBackdrop');
      if (e && e.target === backdrop) return;
      backdrop.style.display = 'none';
    }

    // Override h√†m useTable ƒë·ªÉ ƒë·∫£m b·∫£o logic t·∫°o h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng
    // (Override b·∫•t k·ª≥ h√†m n√†o t·ª´ pages.js ho·∫∑c file kh√°c)
    loadTables();
    loadStatus();
  </script>
</body>
</html>
